##  禁止指令重排

- 计算机在执行程序时, 为了提高性能, 编译器和处理器常常会对指令做重排

![](https://youpaiyun.zongqilive.cn/image/20200712150908.png)

- 单线程环境里面确保程序最终执行结果和代码顺序执行的结果一致
- 处理器在进行重排序时必须要考虑指令之间的数据依赖性
- 多线程环境中线程交替执行, 由于编译器优化重排的存在, 两个线程中使用的变量能否保证一致性是无法确定的, 结果无法预测



## 内存屏障

内存屏障作用:

1. 保证特定操作的执行顺序
2. 保证某些变量的内存可见性（利用该特性实现volatile的内存可见性）

如果在指令间插入一条Memory Barrier 则会告诉编译器和CPU, 不管什么指令都不能和这条Memory Barrier 指令重排序, 也就是说 通过 ==插入内存屏障禁止在内存屏障前后的指令执行重排序优化==. 

内存屏障 另一个作用是 强制刷出各种CPU的缓存数据, 因此任何CPU上的线程都能读取到这些数据的最新版本



内存屏障主要有以下分类:

![](https://youpaiyun.zongqilive.cn/image/20200712152137.png)

JMM保守策略：

1. 在每个volatile写操作的前面插入一个StoreStore屏障
2. 在每个volatile写操作的后面插入一个StoreLoad屏障
3. 在每个volatile读操作的前面插入一个LoadLoad屏障
4. 在每个volatile读操作的后面插入一个LoadStore屏障



![](https://youpaiyun.zongqilive.cn/image/20200712152344.png)

![](https://youpaiyun.zongqilive.cn/image/20200712152419.png)



![](https://youpaiyun.zongqilive.cn/image/20200421164507.png)



**`Volatile` 是可以保持 可见性。不能保证原子性，由于内存屏障，可以保证避免指令重排的现象产生！** 