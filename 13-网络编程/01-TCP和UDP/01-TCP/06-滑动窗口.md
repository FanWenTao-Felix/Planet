# 解释版本1

![](https://ae01.alicdn.com/kf/H809fa26d88b14b79b64e77ed7366cfc2n.png)

1. 首先是 AB 之间三次握手建立 TCP 连接。在报文的交互过程中，A 将自己的缓冲区大小（窗口大小）3发送给 B，B 同理，这样双方就知道了对端的窗口大小。

2. A 开始发送数据，A 连续发送3个单位的数据，因为他知道 B 的缓冲区大小。在这一波数据发送完后，A 就不能再发了，需等待 B 的确认。

3. A 发送过来的数据逐渐将缓冲区填满。

4. 这时候缓冲区中的一个报文被进程读取，缓冲区有了一个空位，于是 B 向 A 发送一个 ACK，这个报文中指示窗口大小为1。

5. A 收到 B 发过来的 ACK 消息，并且知道 B 将窗口大小调整为1，因此他只发送了一个单位的数据并且等待 B 的下一个确认报文。

如此反复。



> TCP规定，即使设置为零窗口，也必须接收以下几种报文段：
>
> - 零窗口探测报文段
> - 确认报文段
> - 携带紧急数据的报文段



















# 解释版本2

## 窗口滑动协议

窗口滑动协议是TCP使用的一种流量控制方法。

该协议允许发送方在停止并等待接收确认报文前`可以连续发送多个分组`。由于发送方不必每发一个分组就停下来等待确认，因此该协议可以加速数据的传输。

只有在接收窗口向前滑动时（与此同时也发送了确认），发送窗口才有可能向前滑动。收发两端的窗口按照以上规律不断地向前滑动，因此这种协议又称为滑动窗口协议。

![](https://ae01.alicdn.com/kf/H431caab4b78b4c21962cf1d143c284d6P.jpg)

1. 窗口大小是指无需等待确认就可以继续发送数据的最大值，上图的窗口大小是4000字节（4段）
2. 发送前4段时，无需ACK，直接发送
3. 收到第一个ACK后，滑动窗口向后移动，继续发送第五段的数据
4. 操作系统内核为了维护这个滑动窗口，需要开辟发送缓冲区来记录当前还有哪些数据没有应答，只有应答的数据才会从缓冲区中删除
5. 窗口越大，则网络的吞吐率就越高



## 滑动窗口丢包原理

### 发送端丢包原理

![](https://ae01.alicdn.com/kf/H17115787c3984d6b90c3d38b232f2c81g.jpg)

当某一段报文丢失了，图中（1001-2000）数据段丢失了，接收方没有接收到该数据段，则会一直给发送端发送ACK（下一个是1001），如果发送端连续收到同样的ACK（下一个是1001），就会将对应的（1001-2000）重新发送，这时候如果接收端收到1001后，再次返回的就是ACK（7001）。这种机制被称为“高速重发机制”（快速重传）



### 接收端丢包原理

![](https://ae01.alicdn.com/kf/H714ad065e70d488da2cec04c1973ee05E.jpg)

接收端的下一个2001丢失了，但是发送端收到了ACK（下一个3001），说明1-3000的数据段已经接收到了，数据已经传输到了发送端，所以不需要理会。





# 持续计时器

存在这样一种情况：发送方接收到零窗口报文之后将发送窗口设置为0，停止发送数据。但等到接收方有足够缓存，发送了非零窗口大小的报文，但是这个报文中途丢失，那么发送方的发送窗口就一直为0导致死锁。
为此，TCP为每一个连接设有一个持续计时器(Persistence Timer)：当TCP连接的一方收到对方的零窗口通知时就启动持续计时器。若持续计时器时间到期，就发送一个零窗口探测报文段(携有1字节的数据)，那么收到这个报文段的一方就在确认这个探测报文段时给出了现在的窗口值。若窗口仍然是零，则收到这个报文段的一方就重新设置持续计时器；若窗口不是零，则死锁的僵局就可以打破了。



# 延迟ACK

如果TCP对每个数据包都发送一个ACK确认，那么只是一个单独的数据包为了发送一个ACK代价比较高，所以TCP会延迟一段时间，如果这段时间内有数据发送到对端，则捎带发送ACK，如果在延迟ACK定时器触发时候，发现ACK尚未发送，则立即单独发送；

延迟ACK好处：

1. 避免糊涂窗口综合症。
2. 发送数据的时候将ACK捎带发送，不必单独发送ACK。如果延迟时间内有多个数据段到达，那么允许协议栈发送一个ACK确认多个报文段。减少流量消耗。

> 糊涂窗口综合症：
>
> TCP接收方的缓存已满，而交互式的应用进程一次只从接收缓存中读取1字节（这样就使接收缓存空间仅腾出1字节），然后向发送方发送确认，并把窗口设置为1个字节（但发送的数据报为40字节的的话）。当发送方又发来1个字节的数据（发送方的IP数据报是41字节），接收方发回确认，仍然将窗口设置为1个字节。这样，网络的效率很低。要解决这个问题，可让接收方等待一段时间，使得或者接收缓存已有足够空间容纳一个最长的报文段或者等到接收方缓存已有一半的空闲空间。只要出现这两种情况，接收方就发回确认报文，并向发送方通知当前的窗口大小。此外，发送方也不要发送太小的报文段，而是把数据报积累成足够大的报文段，或达到接收方缓存的空间的一半大小。

























