MULTI、EXEC、DISCARD、WATCH



Redis通过`MULTI`、`EXEC`、`WATCH`等命令来实现事务功能。

**Redis对事务是部分支持。**

不支持回滚操作, 

![](https://youpaiyun.zongqilive.cn/image/006tNc79ly1g4cj8bwubfj30ta0g4aar.jpg)

1. 首先使用MULTI命令告诉Redis：“下面我发给你的命令属于同一个事务，你先不要执行，而是先暂存起来。” Redis回答：“ OK"
2. 我们发送了两个SADD命令给Redis，Redis没有立即执行它们，而是返回QUEUED,表示这两条命令已经进入等待执行的事务队列中了。
3. 当把所有要在同一个事务中执行的命令都发送给Redis后，我们使用EXEC命令告诉Redis将等待执行的事务队列中的所有命令按照发送顺序依次执行。EXEC命令的返回值就是这些命令的返回值组成的列表，返回值顺序和命令的顺序相同。



一个事务从开始到结束通常经历以下三个阶段：

1. 事务开始。
2. 命令入队。
3. 事务执行。



## 事务开始

MULTI命令的执行标志着事务的开启。

## 命令入队

- 如果客户端发送的命令是`MULTI`、`DISCARD`、`WATCH`、`EXEC`四个中的其中一个，那么服务器立即执行这个命令。
- 如果客户端发送的是上面四个命令以外的其他命令，那么服务器并不立即执行这个命令，而是将这个命令放入到一个事务队列里面，然后向客户端返回`QUEUED`回复。

![](https://youpaiyun.zongqilive.cn/image/006tNc79ly1g4cjaoxvloj30lf0fjq3o.jpg)

## 事务执行

当一个处于事务状态的客户端向服务器发送EXEC命令时，这个EXEC命令将立即被服务器执行。

服务器遍历这个客户端的事务队列，执行队列中保存的所有命令，最后将执行命令所得的结果全部返回给客户端。



## watch命令的使用

**WATCH命令是一个乐观锁**，它可以在EXEC命令执行之前，监视任意数量的数据库键，并在EXEC命令执行时，检查被监视的键是否至少有一个已经被修改过了，如果是的话，服务器将拒绝执行事务，并向客户端返回代表事务执行失败的空回复。

![](https://youpaiyun.zongqilive.cn/image/006tNc79ly1g4ck2mnvoaj31ou0kc40i.jpg)

客户端A执行事务失败。原因分析如下：

在时间T4，客户端B修改了“name"键的值，当客户端A在T5执行EXEC命令时，服务器会发现WATCH监视的键”name“已经被修改，因此服务器拒接执行客户端A的事务，并向客户端A发送了空回复。



















