支持事务消息的MQ，其支持事务消息的方式采用类似于二阶段提交。

基于 MQ 的分布式事务方案其实是对本地消息表的封装，将本地消息表基于 MQ 内部，其他方面的协议基本与本地消息表一致。





![](https://ae01.alicdn.com/kf/Hadea3f47609b42d0ac046c6316be3ec4x.png)



**条件：**

a) 需要补偿逻辑

b) 业务处理逻辑需要幂等



**处理流程：**

c) 消费者向MQ发送half消息。

d) MQ Server将消息持久化后，向发送方ack确认消息发送成功。

e) 消费者开始执行事务逻辑。

f) 消费者根据本地事务执行结果向MQ Server提交二次确认或者回滚。

g) MQ Server收到commit状态则将half消息标记可投递状态。

h) 服务提供者收到该消息，执行本地业务逻辑。返回处理结果。



**优点：**

- 消息数据独立存储，降低业务系统与消息系统之间的耦合。
- 吞吐量优于本地消息表方案。



**缺点：**

- 一次消息发送需要两次网络请求(half消息 + commit/rollback)。
- 需要实现消息回查接口。



